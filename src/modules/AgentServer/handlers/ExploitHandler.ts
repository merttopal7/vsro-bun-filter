import { Packet, StaticTypes } from '@/core';
import { ModuleRegistry } from '@/core/types';
import { PacketResultType } from '@/utils/Types'
import { CLIENT_CHARACTER_SELECTION_JOIN_REQUEST, SERVER_AUTH_RESPONSE } from '@/modules/AgentServer/actions';
import { Data, Session, CharInfo, EntityInfo } from '@/core/Session';
import { EventFactory, EventFactoryNames } from '@/utils/EventFactory';
import { Database } from '@/utils/Database';
import { _Char } from '@/utils/Database/VSRO188/SRO_VT_SHARD/_Char';
const { string, byte, int, short, stringASCII } = StaticTypes;


export class ExploitHandler {
    constructor(server?: ModuleRegistry) {
        if (server)
            this.register(server);
    }

    register(server: ModuleRegistry) {
        server.RegisterClientHandler(CLIENT_CHARACTER_SELECTION_JOIN_REQUEST, this.ON_CLIENT_CHARACTER_SELECTION_JOIN_REQUEST)
        server.RegisterModuleHandler(SERVER_AUTH_RESPONSE, this.ON_SERVER_AUTH_RESPONSE)
    }

    async ON_SERVER_AUTH_RESPONSE(data: SERVER_AUTH_RESPONSE, session: Session) {

        session.SetData(Data.CharInfo, new CharInfo());
        session.SetData(Data.EntityInfo, new EntityInfo(session));
        if (data.Result == 0x01) {
            session.SetData(Data.UserLoggedIn, true);
            EventFactory.Publish(EventFactoryNames.OnUserAgentLogin, session);
        }

        const loggedIn = session.GetData<boolean>(Data.UserLoggedIn, false);
        if (loggedIn) {
            session.SetData(Data.CharScreen, true);
            EventFactory.Publish(EventFactoryNames.OnUserJoinCharScreen, session);
        }
        return data;
    }

    async ON_CLIENT_CHARACTER_SELECTION_JOIN_REQUEST(data: CLIENT_CHARACTER_SELECTION_JOIN_REQUEST, session: Session) {
        const CharNameSent = session.GetData<boolean>(Data.CharNameSent, false);
        if (CharNameSent) {
            data.ResultType = PacketResultType.Block;
            return data;
        }
        const charScreen = session.GetData<boolean>(Data.CharScreen, false);
        if (!charScreen) {
            console.warn(`Client ${session.client.id}(${session.client.ip}) attempted to send 0x7001 outside char screen!`);
            data.ResultType = PacketResultType.Disconnect;
            return data;
        }
        if (data.RemainingRead() != 0) {
            console.warn(`Client [${session.client.id}](${session.client.ip}) attempted to modify 0x7001!`);
            data.ResultType = PacketResultType.Disconnect;
            return data;
        }

        const charInfo = session.GetData<CharInfo>(Data.CharInfo, new CharInfo());
        charInfo.CharName.set(data.Name.get());
        session.SetData(Data.CharNameSent, true);

        EventFactory.Publish(EventFactoryNames.OnUserCharnameSent, session);
        console.log(`Char: [${charInfo?.CharName.get()}](${session.GetId()}) attempt to select`);

        const LoggedChar = await _Char.fromQuery(
            _Char.query()
                .where("CharName16", data.Name.get())
                .first()
        );
        session.SetData(Data.CharId, LoggedChar.CharID);

        const Shard = Database.SRO_VT_SHARD(); //knex Instance for developing quickly.
        const jid: number = (await Shard("_User").where("CharId", LoggedChar.CharID).first())?.UserJID;
        charInfo.Jid = jid;


        if (await LoggedChar.IsMale()) {
            console.log("ERKEKKKK")
        } else console.log("KADINNN")

        return data;
    }

}