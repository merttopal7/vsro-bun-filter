import { Packet, StaticTypes } from '@/core';
import { ModuleRegistry } from '@/core/types';
import { PacketResultType } from '@/utils/Types'
import { CLIENT_CHARACTER_SELECTION_JOIN_REQUEST, SERVER_AUTH_RESPONSE } from '@/modules/AgentServer/actions';
import { Data, Session, CharInfo, EntityInfo } from '@/core/Session';
import { EventFactory, EventFactoryNames } from '@/utils/EventFactory';
const { string, byte, int, short, stringASCII } = StaticTypes;


export class ExploitHandler {
    constructor(server?: ModuleRegistry) {
        if (server)
            this.register(server);
    }

    register(server: ModuleRegistry) {
        server.RegisterClientHandler(CLIENT_CHARACTER_SELECTION_JOIN_REQUEST, this.ON_CLIENT_CHARACTER_SELECTION_JOIN_REQUEST)
        server.RegisterModuleHandler(SERVER_AUTH_RESPONSE, this.ON_SERVER_AUTH_RESPONSE)
    }

    async ON_SERVER_AUTH_RESPONSE(data: SERVER_AUTH_RESPONSE, session: Session) {

        session.SetData(Data.CharInfo, new CharInfo());
        session.SetData(Data.EntityInfo, new EntityInfo(session));
        if (data.Result == 0x01) {
            session.SetData(Data.UserLoggedIn, true);
            EventFactory.Publish(EventFactoryNames.OnUserAgentLogin, session);
        }

        const loggedIn = session.GetData<boolean>(Data.UserLoggedIn, false);
        if (loggedIn) {
            session.SetData(Data.CharScreen, true);
            EventFactory.Publish(EventFactoryNames.OnUserJoinCharScreen, session);
        }
        return data;
    }

    async ON_CLIENT_CHARACTER_SELECTION_JOIN_REQUEST(data: CLIENT_CHARACTER_SELECTION_JOIN_REQUEST, session: Session) {
        console.log(data.Name.get(), session.SessionData.id)
        const CharNameSent = session.GetData<boolean>(Data.CharNameSent, false);
        if (CharNameSent) {
            data.ResultType = PacketResultType.Block;
            return data;
        }
        const charScreen = session.GetData<boolean>(Data.CharScreen, false);
        console.log(charScreen)
        if (!charScreen) {
            console.warn(`Client ${session.client.id}(${session.client.ip}) attempted to send 0x7001 outside char screen!`);
            data.ResultType = PacketResultType.Disconnect;
            return data;
        }
        if (data.RemainingRead() != 0) {
            Log.Warning(`Client ${session.client.id}(${session.client.ip}) attempted to modify 0x7001!`);
            data.ResultType = PacketResultType.Disconnect;
            return data;
        }

        const charInfo = session.GetData<CharInfo>(Data.CharInfo, new CharInfo());
        charInfo.CharName.set(data.Name);
        session.SetData(Data.CharNameSent, true);

        EventFactory.Publish(EventFactoryNames.OnUserCharnameSent, session);
        console.log(`Char: ${charInfo?.CharName} attempt to select`);
        // await using SRO_VT_SHARD db = new SRO_VT_SHARD();
        // int charId = (await db._Chars.Where(x => x.CharName16 == data.Name).FirstAsync()).CharID;
        // int jid = (await db._Users.Where(x => x.CharID == charId).FirstAsync()).UserJID;
        // session.SetData(Data.CharId, charId);
        // charInfo.Jid = (uint)jid;

        return data;
    }

}